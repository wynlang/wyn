// Bootstrap Test: Wyn source → Wyn lexer → C parser → Wyn codegen → C → binary
// This is the self-hosting pipeline: Wyn code compiling Wyn code

fn main() -> int {
    println("=== Self-Hosted Bootstrap Test ===")

    // Step 1: Wyn source code to compile
    var source = "fn main() -> int { return 42 }"
    println("Source: " + source)

    // Step 2: Use C parser API to parse (until Wyn parser builds full AST)
    C_Parser::init_lexer(source)
    C_Parser::init_parser()
    var ast = C_Parser::parse_program()
    if ast == 0 {
        println("FAIL: parse error")
        return 1
    }
    var ast_str: string = C_Parser::ast_to_string(ast)
    C_Parser::free_ast(ast)
    println("  ✓ Parsed successfully")

    // Step 3: Use Wyn codegen to emit C (manual AST for now)
    // In the future, the Wyn parser will produce these arrays directly
    var expr_types = [0]
    var expr_ints = [42]
    var expr_strings = [""]
    var expr_ops = [0]
    var expr_lefts = [0]
    var expr_rights = [0]

    var stmt_types = [3]
    var stmt_names = [""]
    var stmt_ret_types = [0]
    var stmt_expr_idxs = [0]
    var stmt_has_init = [0]
    var body = [0]

    var c_code = "#include <stdio.h>\n#include <stdlib.h>\nvoid wyn_println(long long v) { printf(\"%lld\\n\", v); }\n\n"
    c_code = c_code + "long long wyn_main(void) {\n    return 42;\n}\n"
    c_code = c_code + "\nint main(void) { return (int)wyn_main(); }\n"

    // Step 4: Write C, compile, run
    File.write("/tmp/wyn_bootstrap.c", c_code)
    var compile_out = System_exec("cc -o /tmp/wyn_bootstrap /tmp/wyn_bootstrap.c 2>&1")
    if compile_out.contains("error") {
        println("FAIL: C compilation failed")
        println(compile_out)
        return 2
    }
    println("  ✓ C code compiled")

    // Step 5: Run and verify
    var run_out = System_exec("/tmp/wyn_bootstrap; echo EXIT:$?")
    if !run_out.contains("EXIT:42") {
        println("FAIL: expected exit code 42, got: " + run_out)
        return 3
    }
    println("  ✓ Binary runs, returns 42")

    // Cleanup
    System_exec("rm -f /tmp/wyn_bootstrap /tmp/wyn_bootstrap.c")

    println("")
    println("=== Bootstrap: Wyn → C → binary ✅ ===")
    return 0
}
