fn worker(shared: int, n: int) -> int { Task.add(shared, n) return 0 }
fn gt5(x: int) -> int { return x > 5 }
fn mul10(x: int) -> int { return x * 10 }

fn test_empty() {
    Test.assert_eq_str("".upper(), "", "empty upper")
    Test.assert_eq_int("".len(), 0, "empty len")
    var e = [x for x in 0..0]
    Test.assert_eq_int(e.len(), 0, "empty comp")
}

fn test_numbers() {
    Test.assert(9999999999 > 0, "large int")
    Test.assert_eq_int(Math.abs(-999999999), 999999999, "abs large")
    Test.assert_eq_int(2147483647 + 1, 2147483648, "32bit safe")
}

fn test_string_edge() {
    Test.assert_eq_str("a,,b".split(",")[1], "", "split empty")
    Test.assert("hello".contains(""), "contains empty")
    Test.assert_eq_str("x".repeat(0), "", "repeat 0")
}

fn test_hashmap_edge() {
    var m = HashMap.new()
    Test.assert_eq_int(m.get_int("x"), 0, "missing = 0")
    m.insert_int("k", 0)
    Test.assert(m.contains("k"), "contains zero")
    m.clear()
    Test.assert_eq_int(m.len(), 0, "clear")
}

fn test_spawn_edge() {
    var counter = Task.value(0)
    var f1 = spawn worker(counter, 10)
    var f2 = spawn worker(counter, 20)
    var f3 = spawn worker(counter, 30)
    await f1
    await f2
    await f3
    Test.assert_eq_int(Task.get(counter), 60, "3 spawns")
    var ch = Task.channel(10)
    Task.send(ch, 1)
    Task.send(ch, 2)
    Task.send(ch, 3)
    Test.assert_eq_int(Task.recv(ch), 1, "fifo 1")
    Test.assert_eq_int(Task.recv(ch), 2, "fifo 2")
    Test.assert_eq_int(Task.recv(ch), 3, "fifo 3")
}

fn test_array_chain() {
    var data = [x for x in 1..11]
    var big = data.filter(gt5)
    var processed = big.map(mul10)
    Test.assert_eq_str(processed.join(","), "60,70,80,90,100", "chain")
}

fn test_io_edge() {
    Test.assert_eq_int(File.exists("/no/such/file"), 0, "no file")
    Test.assert_eq_int(File.size("/no/such/file"), 0, "no size")
    var j = Json.parse("{\"a\":{\"b\":42}}")
    var inner = Json.get_object(j, "a")
    Test.assert_eq_int(Json.get_int(inner, "b"), 42, "nested json")
    var csv = Csv.parse("n,v\n\"a,b\",1")
    Test.assert_eq_str(Csv.get(csv, 1, 0), "a,b", "csv quoted")
}

fn test_encoding_edge() {
    Test.assert_eq_str(Encoding.base64_decode(Encoding.base64_encode("a")), "a", "b64 1")
    Test.assert_eq_str(Encoding.base64_decode(Encoding.base64_encode("ab")), "ab", "b64 2")
    Test.assert_eq_str(Encoding.base64_decode(Encoding.base64_encode("abc")), "abc", "b64 3")
    var h1 = Crypto.sha256("test")
    var h2 = Crypto.sha256("test")
    Test.assert_eq_str(h1, h2, "sha256 det")
}

fn test_control_edge() {
    Test.assert(1 == 1 || 0 == 1, "or")
    Test.assert(!(1 == 2), "not")
    var odds = 0
    for i in 0..10 { if i % 2 == 0 { continue } odds = odds + 1 }
    Test.assert_eq_int(odds, 5, "continue")
    Test.assert(DateTime.year(DateTime.now()) >= 2026, "year")
    Test.assert_eq_str(DateTime.format_duration(500), "500ms", "duration")
}

fn main() -> int {
    Test.init("Edge Final")
    test_empty()
    test_numbers()
    test_string_edge()
    test_hashmap_edge()
    test_spawn_edge()
    test_array_chain()
    test_io_edge()
    test_encoding_edge()
    test_control_edge()
    Test.summary()
    return 0
}
